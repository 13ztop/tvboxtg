name: Optimized TVBoxTG Sync

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15   # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡æ­»
    env:
      SOURCE_REPO: "ls125781003/tvboxtg"
      TARGET_REPO: "13ztop/tvboxtg"
    
    steps:
      # 1. å‡†å¤‡é˜¶æ®µ - å¹¶è¡Œè·å–ä»“åº“ä¿¡æ¯
      - name: Setup environment
        id: setup
        run: |
          # è·å–ç›®æ ‡ä»“åº“é»˜è®¤åˆ†æ”¯
          target_branch=$(curl -s -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
            "https://api.github.com/repos/${{ env.TARGET_REPO }}" | jq -r .default_branch)
          
          # è·å–æºä»“åº“æœ€æ–°commit
          source_commit=$(curl -s "https://api.github.com/repos/${{ env.SOURCE_REPO }}/commits/main" | jq -r .sha)
          source_short=${source_commit:0:7}
          
          echo "target_branch=$target_branch" >> $GITHUB_OUTPUT
          echo "source_commit=$source_commit" >> $GITHUB_OUTPUT
          echo "source_short=$source_short" >> $GITHUB_OUTPUT
          echo "TARGET_BRANCH=$target_branch" >> $GITHUB_ENV

      # 2. å¹¶è¡Œå…‹éš†ä»“åº“ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
      - name: Parallel clone repositories
        run: |
          # å…‹éš†æºä»“åº“ï¼ˆè¶…æµ…å…‹éš†ï¼‰
          git clone --depth 1 --filter=blob:none \
            "https://github.com/${{ env.SOURCE_REPO }}.git" source-repo &
            
          # å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆä»…å…‹éš†å¿…è¦åˆ†æ”¯ï¼‰
          git clone --depth 1 --branch "${{ env.TARGET_BRANCH }}" \
            "https://${{ secrets.SYNC_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git" target-repo &
            
          wait # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
          
          echo "ä»“åº“å…‹éš†å®Œæˆ"

      # 3. é«˜æ•ˆè¯†åˆ«ä¿æŠ¤æ–‡ä»¶ï¼ˆä¿®å¤è·¯å¾„æ ¼å¼ï¼‰
      - name: Identify protected files (optimized)
        id: file_protection
        run: |
          # åˆ›å»ºä¿æŠ¤æ–‡ä»¶åˆ—è¡¨ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰
          PROTECTED_LIST="/tmp/protected-list.txt"
          > $PROTECTED_LIST  # æ¸…ç©ºæ–‡ä»¶
          
          # è¿›å…¥ç›®æ ‡ç›®å½•ç”Ÿæˆç›¸å¯¹è·¯å¾„
          cd target-repo
          
          # æ ¸å¿ƒæ–‡ä»¶æ¨¡å¼æ•°ç»„ï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰
          patterns=(
            -name 'README.md'
            -o -name 'LICENSE'
            -o -path '.github/workflows/*'
            -o -name 'config.py'
            -o -name 'credentials.json'
            -o -name 'custom_*.py'
            -o -path 'data/*'
            -o -path 'env/*'
            -o -path 'plugins/*'
            -o -name '.gitignore'
            -o -name '.env'
          )
          
          # æ‰§è¡ŒæŸ¥æ‰¾å¹¶è¾“å‡ºç›¸å¯¹è·¯å¾„
          find . \( "${patterns[@]}" \) -print | sed 's|^\./||' >> $PROTECTED_LIST
          
          # è®¡ç®—ä¿æŠ¤æ–‡ä»¶æ•°é‡
          protected_count=$(wc -l < $PROTECTED_LIST)
          echo "count=$protected_count" >> $GITHUB_OUTPUT
          echo "ä¿æŠ¤æ–‡ä»¶åˆ—è¡¨:"
          cat $PROTECTED_LIST
          echo "ä¿æŠ¤æ–‡ä»¶è¯†åˆ«å®Œæˆ: $protected_count ä¸ªæ–‡ä»¶"

      # 4. æ™ºèƒ½åŒæ­¥ï¼ˆä¿®å¤è·¯å¾„é”™è¯¯ï¼‰
      - name: Smart sync with delta algorithm
        run: |
          # å®‰è£…é«˜æ•ˆåŒæ­¥å·¥å…· (rsyncæ›¿ä»£æ–¹æ¡ˆ)
          sudo apt-get update && sudo apt-get install -y unison
          
          # ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„æ ¼å¼ï¼ˆå»æ‰å‰å¯¼æ–œæ ï¼‰
          echo "ä½¿ç”¨ä¿æŠ¤åˆ—è¡¨:"
          cat /tmp/protected-list.txt
          
          # æ„å»ºUnisonæ’é™¤å‚æ•°ï¼ˆé¿å…ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          exclude_args=()
          while IFS= read -r pattern; do
            exclude_args+=("-ignorenot=Path $pattern")
          done < /tmp/protected-list.txt
          
          # æ‰§è¡ŒåŒæ­¥
          unison -batch -auto -ignore="Name .git" \
            "${exclude_args[@]}" \
            source-repo target-repo
          
          echo "ä»“åº“åŒæ­¥å®Œæˆ"

      # 5. å¿«é€Ÿå˜æ›´æ£€æµ‹
      - name: Detect changes
        id: change_detection
        run: |
          cd target-repo
          
          # è®¾ç½®Gitèº«ä»½
          git config user.name "TVBoxTG Sync Bot"
          git config user.email "tvboxtg-sync@users.noreply.github.com"
          
          # æ£€æµ‹å˜æ›´
          git add -A
          changes=$(git diff --cached --name-only | wc -l)
          
          if [ $changes -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changes_count=$changes" >> $GITHUB_OUTPUT
          else
            echo "no_changes=true" >> $GITHUB_OUTPUT
          fi

      # 6. æäº¤å˜æ›´ï¼ˆæ¡ä»¶æ‰§è¡Œï¼‰
      - name: Commit and push changes
        if: steps.change_detection.outputs.has_changes == 'true'
        run: |
          cd target-repo
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ“º Auto Sync: ${{ env.SOURCE_REPO }}@${{ steps.setup.outputs.source_short }}"
          commit_msg+="\n\nâ€¢ æ›´æ–° ${{ steps.change_detection.outputs.changes_count }} ä¸ªæ–‡ä»¶"
          commit_msg+="\nâ€¢ ä¿ç•™ ${{ steps.file_protection.outputs.count }} ä¸ªè‡ªå®šä¹‰æ–‡ä»¶"
          
          # æäº¤å¹¶æ¨é€
          git commit -m "$commit_msg"
          git push origin "HEAD:${{ env.TARGET_BRANCH }}"
          
          # ä¿å­˜æäº¤ä¿¡æ¯
          echo "commit_msg=$commit_msg" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # 7. è®¾ç½®æ—¶åŒºï¼ˆä¸Šæµ·æ—¶é—´ï¼‰
      - name: Set Shanghai time
        run: |
          TZ_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          TZ_SHORT=$(TZ='Asia/Shanghai' date +'%H:%M %Z')
          echo "CURRENT_TIME=$TZ_TIME" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$TZ_SHORT" >> $GITHUB_ENV

      # 8. é€šçŸ¥ç³»ç»Ÿï¼ˆTelegramï¼‰
      - name: Notify Telegram
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            @{{ (steps.change_detection.outputs.has_changes == 'true') && 'ğŸ“º TVBoxTG åŒæ­¥æˆåŠŸ' || 'â„¹ï¸ TVBoxTG æ— å˜æ›´' }} | ${{ env.CURRENT_TIME_SHORT }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            {{ steps.change_detection.outputs.has_changes && 'ğŸ”„ **æºä»“åº“**: [' + env.SOURCE_REPO + '@' + steps.setup.outputs.source_short + '](https://github.com/' + env.SOURCE_REPO + '/commit/' + steps.setup.outputs.source_commit + ')'
            || 'ğŸ”„ **æºä»“åº“**: [' + env.SOURCE_REPO + '](https://github.com/' + env.SOURCE_REPO + ')' }}
            ğŸ“¦ **ç›®æ ‡ä»“åº“**: [${{ env.TARGET_REPO }}@${{ env.commit_sha || steps.setup.outputs.source_short }}](https://github.com/${{ env.TARGET_REPO }}/commit/${{ env.commit_sha || 'main' }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            {{ steps.change_detection.outputs.has_changes && 'ğŸ“‚ **å˜æ›´æ–‡ä»¶**: ' + steps.change_detection.outputs.changes_count + ' ä¸ª' || 'ğŸ†— **åŒæ­¥çŠ¶æ€**: å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°' }}
            ğŸ”’ **ä¿ç•™æ–‡ä»¶**: ${{ steps.file_protection.outputs.count }} ä¸ª
            ğŸ•’ **æ‰§è¡Œæ—¶é—´**: ${{ env.CURRENT_TIME_SHORT }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            {{ steps.change_detection.outputs.has_changes && 'âœ… åŒæ­¥å®Œæˆ! ä»“åº“å·²æ›´æ–°' || 'âœ… ä»“åº“å·²æ˜¯æœ€æ–°çŠ¶æ€' }}
            [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ env.TARGET_REPO }}/commit/${{ env.commit_sha || 'HEAD' }})
          parse_mode: markdown

      # 9. é”™è¯¯å¤„ç†
      - name: Error notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â€¼ï¸ *TVBoxTG åŒæ­¥å¤±è´¥ | ${{ env.CURRENT_TIME_SHORT }}*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âš™ï¸ **å·¥ä½œæµ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ğŸ•’ **å‘ç”Ÿæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âŒ é”™è¯¯è¯¦æƒ…: è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—
            [ç«‹å³æŸ¥çœ‹](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown

      # 10. æ¸…ç†å·¥ä½œåŒº
      - name: Cleanup
        if: always()
        run: |
          rm -rf source-repo target-repo
          rm -f /tmp/protected-list.txt
