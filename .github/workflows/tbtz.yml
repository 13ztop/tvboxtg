name: Optimized TVBoxTG Sync

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15   # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡æ­»
    env:
      SOURCE_REPO: "ls125781003/tvboxtg"
      TARGET_REPO: "13ztop/tvboxtg"
    
    steps:
      # 1. å‡†å¤‡é˜¶æ®µ - å¹¶è¡Œè·å–ä»“åº“ä¿¡æ¯
      - name: Setup environment
        id: setup
        run: |
          # è·å–ç›®æ ‡ä»“åº“é»˜è®¤åˆ†æ”¯
          target_branch=$(curl -s -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
            "https://api.github.com/repos/${{ env.TARGET_REPO }}" | jq -r .default_branch)
          
          # è·å–æºä»“åº“æœ€æ–°commit
          source_commit=$(curl -s "https://api.github.com/repos/${{ env.SOURCE_REPO }}/commits/main" | jq -r .sha)
          source_short=${source_commit:0:7}
          
          echo "target_branch=$target_branch" >> $GITHUB_OUTPUT
          echo "source_commit=$source_commit" >> $GITHUB_OUTPUT
          echo "source_short=$source_short" >> $GITHUB_OUTPUT
          echo "TARGET_BRANCH=$target_branch" >> $GITHUB_ENV

      # 2. å¹¶è¡Œå…‹éš†ä»“åº“
      - name: Parallel clone repositories
        run: |
          git clone --depth 1 --filter=blob:none \
            "https://github.com/${{ env.SOURCE_REPO }}.git" source-repo &
            
          git clone --depth 1 --branch "${{ env.TARGET_BRANCH }}" \
            "https://${{ secrets.SYNC_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git" target-repo &
            
          wait
          echo "ä»“åº“å…‹éš†å®Œæˆ"

      # 3. é«˜æ•ˆè¯†åˆ«ä¿æŠ¤æ–‡ä»¶
      - name: Identify protected files
        id: file_protection
        run: |
          PROTECTED_LIST="/tmp/protected-list.txt"
          > $PROTECTED_LIST
          
          cd target-repo
          
          # ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ¨¡å¼
          find . \( \
            -name 'README.md' \
            -o -name 'LICENSE' \
            -o -path './.github/workflows/*' \
            -o -name 'config.py' \
            -o -name 'credentials.json' \
            -o -name 'custom_*.py' \
            -o -path './data/*' \
            -o -path './env/*' \
            -o -path './plugins/*' \
            -o -name '.gitignore' \
            -o -name '.env' \
          \) -print | sed 's|^\./||' >> $PROTECTED_LIST
          
          protected_count=$(wc -l < $PROTECTED_LIST)
          echo "count=$protected_count" >> $GITHUB_OUTPUT
          echo "ä¿æŠ¤æ–‡ä»¶åˆ—è¡¨:"
          cat $PROTECTED_LIST

      # 4. æ™ºèƒ½åŒæ­¥ï¼ˆä½¿ç”¨rsyncæ›¿ä»£Unisonï¼‰
      - name: Smart sync with rsync
        run: |
          # å®‰è£…rsync
          sudo apt-get update && sudo apt-get install -y rsync
          
          # ç”Ÿæˆæ’é™¤æ–‡ä»¶åˆ—è¡¨
          EXCLUDE_FILE="/tmp/exclude-list.txt"
          echo ".git" > $EXCLUDE_FILE
          echo ".github" >> $EXCLUDE_FILE
          
          # æ·»åŠ ä¿æŠ¤æ–‡ä»¶åˆ°åŒ…å«åˆ—è¡¨
          if [ -s /tmp/protected-list.txt ]; then
            while IFS= read -r pattern; do
              echo "$pattern" >> $EXCLUDE_FILE
            done < /tmp/protected-list.txt
          fi
          
          echo "æ’é™¤åˆ—è¡¨:"
          cat $EXCLUDE_FILE
          
          # æ‰§è¡ŒrsyncåŒæ­¥
          rsync -av --delete \
            --exclude-from="$EXCLUDE_FILE" \
            source-repo/ target-repo/
          
          echo "ä»“åº“åŒæ­¥å®Œæˆ"

      # 5. å¿«é€Ÿå˜æ›´æ£€æµ‹
      - name: Detect changes
        id: change_detection
        run: |
          cd target-repo
          
          git config user.name "TVBoxTG Sync Bot"
          git config user.email "tvboxtg-sync@users.noreply.github.com"
          
          git add -A
          changes=$(git diff --cached --name-only | wc -l)
          
          if [ $changes -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changes_count=$changes" >> $GITHUB_OUTPUT
          else
            echo "no_changes=true" >> $GITHUB_OUTPUT
          fi

      # 6. æäº¤å˜æ›´
      - name: Commit and push changes
        if: steps.change_detection.outputs.has_changes == 'true'
        run: |
          cd target-repo
          
          commit_msg="ğŸ“º Auto Sync: ${{ env.SOURCE_REPO }}@${{ steps.setup.outputs.source_short }}"
          commit_msg+=$'\n\nâ€¢ æ›´æ–° '"${{ steps.change_detection.outputs.changes_count }}"$' ä¸ªæ–‡ä»¶'
          commit_msg+=$'\nâ€¢ ä¿ç•™ '"${{ steps.file_protection.outputs.count }}"$' ä¸ªè‡ªå®šä¹‰æ–‡ä»¶'
          
          git commit -m "$commit_msg"
          git push origin "HEAD:${{ env.TARGET_BRANCH }}"
          
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "full_sha=$(git rev-parse HEAD)" >> $GITHUB_ENV

      # 7. è®¾ç½®æ—¶åŒº
      - name: Set Shanghai time
        run: |
          TZ_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          TZ_SHORT=$(TZ='Asia/Shanghai' date +'%H:%M %Z')
          echo "CURRENT_TIME=$TZ_TIME" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$TZ_SHORT" >> $GITHUB_ENV

      # 8. é€šçŸ¥ç³»ç»Ÿï¼ˆä¿®å¤Telegramå‚æ•°é—®é¢˜ï¼‰
      - name: Notify Telegram
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown  # ä½¿ç”¨formatæ›¿ä»£parse_mode
          message: |
            ${{ steps.change_detection.outputs.has_changes && 'ğŸ“º TVBoxTG åŒæ­¥æˆåŠŸ' || 'â„¹ï¸ TVBoxTG æ— å˜æ›´' }} | ${{ env.CURRENT_TIME_SHORT }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ steps.change_detection.outputs.has_changes && format('ğŸ”„ **æºä»“åº“**: [{0}@{1}](https://github.com/{0}/commit/{2})', env.SOURCE_REPO, steps.setup.outputs.source_short, steps.setup.outputs.source_commit) || format('ğŸ”„ **æºä»“åº“**: [{0}](https://github.com/{0})', env.SOURCE_REPO) }}
            ğŸ“¦ **ç›®æ ‡ä»“åº“**: [${{ env.TARGET_REPO }}@${{ env.commit_sha || steps.setup.outputs.source_short }}](https://github.com/${{ env.TARGET_REPO }}/commit/${{ env.full_sha || steps.setup.outputs.source_commit }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ steps.change_detection.outputs.has_changes && format('ğŸ“‚ **å˜æ›´æ–‡ä»¶**: {0} ä¸ª', steps.change_detection.outputs.changes_count) || 'ğŸ†— **åŒæ­¥çŠ¶æ€**: å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°' }}
            ğŸ”’ **ä¿ç•™æ–‡ä»¶**: ${{ steps.file_protection.outputs.count }} ä¸ª
            ğŸ•’ **æ‰§è¡Œæ—¶é—´**: ${{ env.CURRENT_TIME_SHORT }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ steps.change_detection.outputs.has_changes && 'âœ… åŒæ­¥å®Œæˆ! ä»“åº“å·²æ›´æ–°' || 'âœ… ä»“åº“å·²æ˜¯æœ€æ–°çŠ¶æ€' }}
            [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ env.TARGET_REPO }}/tree/${{ env.TARGET_BRANCH }})

      # 9. é”™è¯¯å¤„ç†
      - name: Error notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            â€¼ï¸ *TVBoxTG åŒæ­¥å¤±è´¥ | ${{ env.CURRENT_TIME_SHORT }}*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âš™ï¸ **å·¥ä½œæµ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ğŸ•’ **å‘ç”Ÿæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âŒ é”™è¯¯è¯¦æƒ…: è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—
            [ç«‹å³æŸ¥çœ‹](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      # 10. æ¸…ç†å·¥ä½œåŒº
      - name: Cleanup
        if: always()
        run: |
          rm -rf source-repo target-repo
          rm -f /tmp/protected-list.txt /tmp/exclude-list.txt
